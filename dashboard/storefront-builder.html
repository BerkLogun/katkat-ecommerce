<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storefront Builder - Customize Your Store</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            border-radius: 15px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .builder-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
            min-height: 80vh;
        }

        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .sidebar h3 {
            margin-bottom: 20px;
            color: #667eea;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .preview-area {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .preview-title {
            font-size: 1.5em;
            font-weight: 600;
        }

        .preview-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .color-picker {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-picker input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .color-picker input[type="text"] {
            flex: 1;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section h4 {
            margin-bottom: 15px;
            color: #667eea;
            font-size: 1.1em;
        }

        .preview-frame {
            width: 100%;
            height: 600px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: #666;
        }

        .preview-frame iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: 500;
        }

        .tab:hover {
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .save-status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        .save-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .save-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .save-status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .layout-preview {
            display: grid;
            gap: 15px;
            margin-top: 15px;
        }

        .layout-option {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .layout-option:hover {
            border-color: #667eea;
        }

        .layout-option.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .layout-option h5 {
            margin-bottom: 10px;
            color: #333;
        }

        .layout-option p {
            font-size: 0.9em;
            color: #666;
        }

        .feature-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .feature-toggle:last-child {
            border-bottom: none;
        }

        .feature-info h5 {
            margin-bottom: 5px;
            color: #333;
        }

        .feature-info p {
            font-size: 0.9em;
            color: #666;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(26px);
        }

        .url-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #e0e0e0;
        }

        .url-display h5 {
            margin-bottom: 10px;
            color: #333;
        }

        .url-display a {
            color: #667eea;
            text-decoration: none;
            word-break: break-all;
        }

        .url-display a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .builder-layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: static;
            }

            .preview-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Storefront Builder</h1>
            <p>Customize your store's appearance, features, and branding</p>
        </div>

        <div class="save-status" id="save-status" style="display: none;"></div>

        <div class="builder-layout">
            <div class="sidebar">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('general')">General</div>
                    <div class="tab" onclick="switchTab('theme')">Theme</div>
                    <div class="tab" onclick="switchTab('features')">Features</div>
                    <div class="tab" onclick="switchTab('advanced')">Advanced</div>
                </div>

                <!-- General Settings Tab -->
                <div class="tab-content active" id="general-tab">
                    <div class="section">
                        <h4>Store Information</h4>
                        <div class="form-group">
                            <label for="store-name">Store Name</label>
                            <input type="text" id="store-name" placeholder="Enter your store name">
                        </div>
                        <div class="form-group">
                            <label for="store-description">Store Description</label>
                            <textarea id="store-description" placeholder="Describe your store"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="store-logo">Logo URL</label>
                            <input type="url" id="store-logo" placeholder="https://example.com/logo.png">
                        </div>
                        <div class="form-group">
                            <label for="store-favicon">Favicon URL</label>
                            <input type="url" id="store-favicon" placeholder="https://example.com/favicon.ico">
                        </div>
                    </div>

                    <div class="section">
                        <h4>Contact Information</h4>
                        <div class="form-group">
                            <label for="contact-email">Email</label>
                            <input type="email" id="contact-email" placeholder="contact@yourstore.com">
                        </div>
                        <div class="form-group">
                            <label for="contact-phone">Phone</label>
                            <input type="tel" id="contact-phone" placeholder="+1 234 567 890">
                        </div>
                        <div class="form-group">
                            <label for="contact-address">Address</label>
                            <textarea id="contact-address" placeholder="Your store address"></textarea>
                        </div>
                    </div>

                    <div class="section">
                        <h4>Social Media</h4>
                        <div class="form-group">
                            <label for="facebook-url">Facebook URL</label>
                            <input type="url" id="facebook-url" placeholder="https://facebook.com/yourstore">
                        </div>
                        <div class="form-group">
                            <label for="twitter-url">Twitter URL</label>
                            <input type="url" id="twitter-url" placeholder="https://twitter.com/yourstore">
                        </div>
                        <div class="form-group">
                            <label for="instagram-url">Instagram URL</label>
                            <input type="url" id="instagram-url" placeholder="https://instagram.com/yourstore">
                        </div>
                        <div class="form-group">
                            <label for="linkedin-url">LinkedIn URL</label>
                            <input type="url" id="linkedin-url" placeholder="https://linkedin.com/company/yourstore">
                        </div>
                    </div>
                </div>

                <!-- Theme Settings Tab -->
                <div class="tab-content" id="theme-tab">
                    <div class="section">
                        <h4>Color Scheme</h4>
                        <div class="form-group">
                            <label for="primary-color">Primary Color</label>
                            <div class="color-picker">
                                <input type="color" id="primary-color-picker" value="#667eea">
                                <input type="text" id="primary-color" value="#667eea">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="secondary-color">Secondary Color</label>
                            <div class="color-picker">
                                <input type="color" id="secondary-color-picker" value="#764ba2">
                                <input type="text" id="secondary-color" value="#764ba2">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="accent-color">Accent Color</label>
                            <div class="color-picker">
                                <input type="color" id="accent-color-picker" value="#e74c3c">
                                <input type="text" id="accent-color" value="#e74c3c">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="background-color">Background Color</label>
                            <div class="color-picker">
                                <input type="color" id="background-color-picker" value="#f8f9fa">
                                <input type="text" id="background-color" value="#f8f9fa">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="text-color">Text Color</label>
                            <div class="color-picker">
                                <input type="color" id="text-color-picker" value="#333333">
                                <input type="text" id="text-color" value="#333333">
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <h4>Layout Settings</h4>
                        <div class="form-group">
                            <label for="layout-type">Product Layout</label>
                            <div class="layout-preview">
                                <div class="layout-option selected" data-layout="grid">
                                    <h5>Grid Layout</h5>
                                    <p>Products displayed in a responsive grid</p>
                                </div>
                                <div class="layout-option" data-layout="list">
                                    <h5>List Layout</h5>
                                    <p>Products displayed in a vertical list</p>
                                </div>
                                <div class="layout-option" data-layout="masonry">
                                    <h5>Masonry Layout</h5>
                                    <p>Products displayed in a Pinterest-style layout</p>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="products-per-page">Products per Page</label>
                            <select id="products-per-page">
                                <option value="6">6 products</option>
                                <option value="12" selected>12 products</option>
                                <option value="24">24 products</option>
                                <option value="48">48 products</option>
                            </select>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="show-images" checked>
                            <label for="show-images">Show product images</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="show-prices" checked>
                            <label for="show-prices">Show product prices</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="show-descriptions" checked>
                            <label for="show-descriptions">Show product descriptions</label>
                        </div>
                    </div>
                </div>

                <!-- Features Tab -->
                <div class="tab-content" id="features-tab">
                    <div class="section">
                        <h4>Store Features</h4>
                        <div class="feature-toggle">
                            <div class="feature-info">
                                <h5>Search Functionality</h5>
                                <p>Allow customers to search products</p>
                            </div>
                            <div class="toggle-switch active" id="search-toggle"></div>
                        </div>
                        <div class="feature-toggle">
                            <div class="feature-info">
                                <h5>Product Filters</h5>
                                <p>Enable filtering and sorting options</p>
                            </div>
                            <div class="toggle-switch active" id="filters-toggle"></div>
                        </div>
                        <div class="feature-toggle">
                            <div class="feature-info">
                                <h5>Wishlist</h5>
                                <p>Allow customers to save favorite products</p>
                            </div>
                            <div class="toggle-switch" id="wishlist-toggle"></div>
                        </div>
                        <div class="feature-toggle">
                            <div class="feature-info">
                                <h5>Product Reviews</h5>
                                <p>Enable customer reviews and ratings</p>
                            </div>
                            <div class="toggle-switch" id="reviews-toggle"></div>
                        </div>
                        <div class="feature-toggle">
                            <div class="feature-info">
                                <h5>Related Products</h5>
                                <p>Show related products on product pages</p>
                            </div>
                            <div class="toggle-switch active" id="related-toggle"></div>
                        </div>
                    </div>

                    <div class="section">
                        <h4>Checkout Settings</h4>
                        <div class="feature-toggle">
                            <div class="feature-info">
                                <h5>Guest Checkout</h5>
                                <p>Allow customers to checkout without account</p>
                            </div>
                            <div class="toggle-switch active" id="guest-checkout-toggle"></div>
                        </div>
                        <div class="feature-toggle">
                            <div class="feature-info">
                                <h5>Require Account</h5>
                                <p>Force customers to create accounts</p>
                            </div>
                            <div class="toggle-switch" id="require-account-toggle"></div>
                        </div>
                        <div class="feature-toggle">
                            <div class="feature-info">
                                <h5>Coupon Codes</h5>
                                <p>Enable discount coupon functionality</p>
                            </div>
                            <div class="toggle-switch" id="coupons-toggle"></div>
                        </div>
                        <div class="feature-toggle">
                            <div class="feature-info">
                                <h5>Gift Cards</h5>
                                <p>Enable gift card purchases</p>
                            </div>
                            <div class="toggle-switch" id="gift-cards-toggle"></div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Tab -->
                <div class="tab-content" id="advanced-tab">
                    <div class="section">
                        <h4>SEO Settings</h4>
                        <div class="form-group">
                            <label for="meta-title">Meta Title</label>
                            <input type="text" id="meta-title" placeholder="Your store's meta title">
                        </div>
                        <div class="form-group">
                            <label for="meta-description">Meta Description</label>
                            <textarea id="meta-description" placeholder="Your store's meta description"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="meta-keywords">Meta Keywords</label>
                            <input type="text" id="meta-keywords" placeholder="keyword1, keyword2, keyword3">
                        </div>
                    </div>

                    <div class="section">
                        <h4>Analytics</h4>
                        <div class="form-group">
                            <label for="google-analytics">Google Analytics ID</label>
                            <input type="text" id="google-analytics" placeholder="GA_MEASUREMENT_ID">
                        </div>
                        <div class="form-group">
                            <label for="facebook-pixel">Facebook Pixel ID</label>
                            <input type="text" id="facebook-pixel" placeholder="PIXEL_ID">
                        </div>
                    </div>

                    <div class="section">
                        <h4>Custom Code</h4>
                        <div class="form-group">
                            <label for="custom-css">Custom CSS</label>
                            <textarea id="custom-css" placeholder="/* Your custom CSS here */"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="custom-js">Custom JavaScript</label>
                            <textarea id="custom-js" placeholder="// Your custom JavaScript here"></textarea>
                        </div>
                    </div>
                </div>

                <button class="btn btn-success" style="width: 100%; margin-top: 20px;" onclick="saveConfiguration()">
                    Save Configuration
                </button>
            </div>

            <div class="preview-area">
                <div class="preview-header">
                    <div class="preview-title">Live Preview</div>
                    <div class="preview-actions">
                        <button class="btn btn-secondary" onclick="refreshPreview()">Refresh Preview</button>
                        <button class="btn btn-primary" onclick="openStorefront()">Open Storefront</button>
                    </div>
                </div>

                <div class="preview-frame" id="preview-frame">
                    <div>Loading preview...</div>
                </div>

                <div class="url-display">
                    <h5>Your Storefront URL</h5>
                    <a href="#" id="storefront-url" target="_blank">Loading...</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentConfig = {};
        let tenantName = '';

        // Initialize the builder
        async function initializeBuilder() {
            try {
                // Get tenant from URL
                const hostname = window.location.hostname;
                tenantName = hostname.split('.')[0];
                
                // Load current configuration
                await loadCurrentConfiguration();
                
                // Set up event listeners
                setupEventListeners();
                
                // Load preview
                loadPreview();
                
            } catch (error) {
                console.error('Failed to initialize builder:', error);
                showSaveStatus('Failed to load configuration', 'error');
            }
        }

        // Load current configuration
        async function loadCurrentConfiguration() {
            // Use the same hostname as the current page but with port 8000 for the API
            const apiHost = window.location.hostname;
            const apiUrl = `http://${apiHost}:8000/api/storefront/config/`;
            
            const response = await fetch(apiUrl, {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'X-Tenant-ID': tenantName
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to load configuration');
            }
            
            const data = await response.json();
            currentConfig = data.storefront;
            
            // Populate form fields
            populateFormFields();
        }

        // Populate form fields with current configuration
        function populateFormFields() {
            // Store Information
            document.getElementById('store-name').value = currentConfig.store_name || '';
            document.getElementById('store-description').value = currentConfig.store_description || '';
            document.getElementById('store-logo').value = currentConfig.store_logo_url || '';
            document.getElementById('store-favicon').value = currentConfig.store_favicon_url || '';
            
            // Contact Information
            document.getElementById('contact-email').value = currentConfig.contact?.email || '';
            document.getElementById('contact-phone').value = currentConfig.contact?.phone || '';
            document.getElementById('contact-address').value = currentConfig.contact?.address || '';
            
            // Social Media
            document.getElementById('facebook-url').value = currentConfig.social_media?.facebook || '';
            document.getElementById('twitter-url').value = currentConfig.social_media?.twitter || '';
            document.getElementById('instagram-url').value = currentConfig.social_media?.instagram || '';
            document.getElementById('linkedin-url').value = currentConfig.social_media?.linkedin || '';
            
            // Theme Colors
            document.getElementById('primary-color').value = currentConfig.theme_config?.colors?.primary || '#667eea';
            document.getElementById('primary-color-picker').value = currentConfig.theme_config?.colors?.primary || '#667eea';
            document.getElementById('secondary-color').value = currentConfig.theme_config?.colors?.secondary || '#764ba2';
            document.getElementById('secondary-color-picker').value = currentConfig.theme_config?.colors?.secondary || '#764ba2';
            document.getElementById('accent-color').value = currentConfig.theme_config?.colors?.accent || '#e74c3c';
            document.getElementById('accent-color-picker').value = currentConfig.theme_config?.colors?.accent || '#e74c3c';
            document.getElementById('background-color').value = currentConfig.theme_config?.colors?.background || '#f8f9fa';
            document.getElementById('background-color-picker').value = currentConfig.theme_config?.colors?.background || '#f8f9fa';
            document.getElementById('text-color').value = currentConfig.theme_config?.colors?.text || '#333333';
            document.getElementById('text-color-picker').value = currentConfig.theme_config?.colors?.text || '#333333';
            
            // Layout Settings
            document.getElementById('products-per-page').value = currentConfig.theme_config?.layout?.products_per_page || 12;
            document.getElementById('show-images').checked = currentConfig.theme_config?.layout?.show_images !== false;
            document.getElementById('show-prices').checked = currentConfig.theme_config?.layout?.show_prices !== false;
            document.getElementById('show-descriptions').checked = currentConfig.theme_config?.layout?.show_descriptions !== false;
            
            // Set layout option
            const layoutType = currentConfig.theme_config?.layout?.type || 'grid';
            document.querySelectorAll('.layout-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.layout === layoutType) {
                    option.classList.add('selected');
                }
            });
            
            // Features
            setToggleState('search-toggle', currentConfig.theme_config?.features?.search !== false);
            setToggleState('filters-toggle', currentConfig.theme_config?.features?.filters !== false);
            setToggleState('wishlist-toggle', currentConfig.theme_config?.features?.wishlist === true);
            setToggleState('reviews-toggle', currentConfig.theme_config?.features?.reviews === true);
            setToggleState('related-toggle', currentConfig.theme_config?.features?.related_products !== false);
            
            // Checkout Settings
            setToggleState('guest-checkout-toggle', currentConfig.theme_config?.checkout?.guest_checkout !== false);
            setToggleState('require-account-toggle', currentConfig.theme_config?.checkout?.require_account === true);
            setToggleState('coupons-toggle', currentConfig.theme_config?.checkout?.coupons === true);
            setToggleState('gift-cards-toggle', currentConfig.theme_config?.checkout?.gift_cards === true);
            
            // SEO Settings
            document.getElementById('meta-title').value = currentConfig.seo?.meta_title || '';
            document.getElementById('meta-description').value = currentConfig.seo?.meta_description || '';
            document.getElementById('meta-keywords').value = currentConfig.seo?.meta_keywords || '';
            
            // Analytics
            document.getElementById('google-analytics').value = currentConfig.analytics?.google_analytics || '';
            document.getElementById('facebook-pixel').value = currentConfig.analytics?.facebook_pixel || '';
            
            // Custom Code
            document.getElementById('custom-css').value = currentConfig.custom_css || '';
            document.getElementById('custom-js').value = currentConfig.custom_js || '';
        }

        // Set up event listeners
        function setupEventListeners() {
            // Color picker synchronization
            const colorPickers = document.querySelectorAll('input[type="color"]');
            colorPickers.forEach(picker => {
                picker.addEventListener('input', function() {
                    const textInput = document.getElementById(this.id.replace('-picker', ''));
                    textInput.value = this.value;
                });
            });
            
            const colorTexts = document.querySelectorAll('input[type="text"]');
            colorTexts.forEach(text => {
                if (text.id.includes('color') && !text.id.includes('picker')) {
                    text.addEventListener('input', function() {
                        const picker = document.getElementById(this.id + '-picker');
                        if (picker) {
                            picker.value = this.value;
                        }
                    });
                }
            });
            
            // Layout options
            document.querySelectorAll('.layout-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.layout-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
            
            // Toggle switches
            document.querySelectorAll('.toggle-switch').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                });
            });
        }

        // Set toggle state
        function setToggleState(toggleId, isActive) {
            const toggle = document.getElementById(toggleId);
            if (toggle) {
                if (isActive) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }
            }
        }

        // Switch tabs
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Save configuration
        async function saveConfiguration() {
            showSaveStatus('Saving configuration...', 'loading');
            
            try {
                const config = buildConfigurationObject();
                
                // Use the same hostname as the current page but with port 8000 for the API
                const apiHost = window.location.hostname;
                const apiUrl = `http://${apiHost}:8000/api/storefront/config/update/`;
                
                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Tenant-ID': tenantName
                    },
                    body: JSON.stringify(config)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save configuration');
                }
                
                const result = await response.json();
                showSaveStatus('Configuration saved successfully!', 'success');
                
                // Update current config
                currentConfig = { ...currentConfig, ...config };
                
                // Refresh preview
                setTimeout(loadPreview, 1000);
                
            } catch (error) {
                console.error('Failed to save configuration:', error);
                showSaveStatus('Failed to save configuration', 'error');
            }
        }

        // Build configuration object from form
        function buildConfigurationObject() {
            const selectedLayout = document.querySelector('.layout-option.selected').dataset.layout;
            
            return {
                store_name: document.getElementById('store-name').value,
                store_description: document.getElementById('store-description').value,
                store_logo_url: document.getElementById('store-logo').value,
                store_favicon_url: document.getElementById('store-favicon').value,
                
                contact: {
                    email: document.getElementById('contact-email').value,
                    phone: document.getElementById('contact-phone').value,
                    address: document.getElementById('contact-address').value
                },
                
                social_media: {
                    facebook: document.getElementById('facebook-url').value,
                    twitter: document.getElementById('twitter-url').value,
                    instagram: document.getElementById('instagram-url').value,
                    linkedin: document.getElementById('linkedin-url').value
                },
                
                colors: {
                    primary: document.getElementById('primary-color').value,
                    secondary: document.getElementById('secondary-color').value,
                    accent: document.getElementById('accent-color').value,
                    background: document.getElementById('background-color').value,
                    text: document.getElementById('text-color').value
                },
                
                layout: {
                    type: selectedLayout,
                    products_per_page: parseInt(document.getElementById('products-per-page').value),
                    show_images: document.getElementById('show-images').checked,
                    show_prices: document.getElementById('show-prices').checked,
                    show_descriptions: document.getElementById('show-descriptions').checked
                },
                
                features: {
                    search: document.getElementById('search-toggle').classList.contains('active'),
                    filters: document.getElementById('filters-toggle').classList.contains('active'),
                    wishlist: document.getElementById('wishlist-toggle').classList.contains('active'),
                    reviews: document.getElementById('reviews-toggle').classList.contains('active'),
                    related_products: document.getElementById('related-toggle').classList.contains('active')
                },
                
                checkout: {
                    guest_checkout: document.getElementById('guest-checkout-toggle').classList.contains('active'),
                    require_account: document.getElementById('require-account-toggle').classList.contains('active'),
                    coupons: document.getElementById('coupons-toggle').classList.contains('active'),
                    gift_cards: document.getElementById('gift-cards-toggle').classList.contains('active')
                },
                
                seo: {
                    meta_title: document.getElementById('meta-title').value,
                    meta_description: document.getElementById('meta-description').value,
                    meta_keywords: document.getElementById('meta-keywords').value
                },
                
                analytics: {
                    google_analytics: document.getElementById('google-analytics').value,
                    facebook_pixel: document.getElementById('facebook-pixel').value
                },
                
                custom_css: document.getElementById('custom-css').value,
                custom_js: document.getElementById('custom-js').value
            };
        }

        // Show save status
        function showSaveStatus(message, type) {
            const status = document.getElementById('save-status');
            status.textContent = message;
            status.className = `save-status ${type}`;
            status.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }

        // Load preview
        function loadPreview() {
            const previewFrame = document.getElementById('preview-frame');
            const storefrontUrl = `http://${tenantName}.localhost:3000/dynamic-storefront.html`;
            
            previewFrame.innerHTML = `<iframe src="${storefrontUrl}"></iframe>`;
            
            // Update storefront URL
            document.getElementById('storefront-url').href = storefrontUrl;
            document.getElementById('storefront-url').textContent = storefrontUrl;
        }

        // Refresh preview
        function refreshPreview() {
            loadPreview();
        }

        // Open storefront
        function openStorefront() {
            const storefrontUrl = `http://${tenantName}.localhost:3000/dynamic-storefront.html`;
            window.open(storefrontUrl, '_blank');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeBuilder);
    </script>
</body>
</html> 